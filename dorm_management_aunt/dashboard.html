<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .room-card { 
            cursor: pointer; 
            transition: transform 0.2s; 
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .room-card:active { transform: scale(0.95); } /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        
        /* ‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á */
        .status-available { border-top: 5px solid #28a745; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        .status-occupied { border-top: 5px solid #dc3545; }  /* ‡πÅ‡∏î‡∏á */
        .status-maintenance { border-top: 5px solid #6c757d; } /* ‡πÄ‡∏ó‡∏≤ */

        .room-number { font-size: 1.2rem; font-weight: bold; }
        .tenant-name { font-size: 0.9rem; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
		

        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 
            50% { opacity: 0.5; } 
        }
        
		/* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á */
        .status-badge {
            position: absolute;
            top: 2px;           /* ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            right: 2px;         /* ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            font-size: 0.6rem;  /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡πÄ‡∏î‡∏¥‡∏° 0.75) */
            padding: 2px 5px;   /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            z-index: 10;
            border-radius: 4px;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏ô‡∏õ‡πâ‡∏≤‡∏¢ */
        .room-card .card-body {
            padding-top: 1.8rem !important; /* ‡∏î‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top" style="background-color: #fd7e14;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-building"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‡∏≠‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå‡∏õ‡πâ‡∏≤‡∏õ‡∏¥‡πà‡∏ô</a>
			<div class="d-flex align-items-center">
				<span class="navbar-text text-white me-3 d-none d-sm-block" id="userDisplay">...</span>
				
				<a href="report.html" class="btn btn-sm btn-light text-primary fw-bold me-2 shadow-sm">
					<i class="fas fa-chart-line"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
				</a>

				<button onclick="logout()" class="btn btn-sm btn-outline-light">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
			</div>
        </div>
    </nav>
	
	<div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-2 d-flex justify-content-between align-items-center bg-white rounded">
            <h5 class="mb-0 text-primary"><i class="fas fa-building"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h5>
            <div style="font-size: 1.1rem;">
                <span class="badge bg-secondary me-2">
                    <i class="fas fa-door-closed"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="statTotal" class="fw-bold">0</span>
                </span>
                <span class="badge bg-success">
                    <i class="fas fa-user-check"></i> ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏ä‡πà‡∏≤ <span id="statOccupied" class="fw-bold">0</span>
                </span>
            </div>
        </div>
    </div>
	
	<div class="container mt-3">
		<div id="alertArea" class="alert alert-warning shadow-sm d-none">
			<strong>üîî ‡∏£‡∏≠‡∏ö‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ:</strong> 
			<span id="dueRoomList"></span>
		</div>
	</div>

    <div class="container py-4" id="mainContainer">
        <div class="text-center py-5" id="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å...</p>
        </div>
        </div>
	<div class="modal fade" id="meterModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color: #fd7e14;">
                <h5 class="modal-title"><i class="fas fa-edit"></i> ‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡πâ‡∏≠‡∏á <span id="modalRoomNum"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalContractId">
                
                <div class="alert alert-info py-2">
                    <small>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤: <strong id="modalTenantName">-</strong></small>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•)</label>
                        <input type="date" id="recordDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢</label>
                        <input type="date" id="dueDate" class="form-control form-control-sm">
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label text-primary fw-bold">üíß ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥</label>
                        <input type="number" id="inputWater" class="form-control form-control-lg text-center" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                        <div class="form-text text-end">‡πÄ‡∏î‡∏¥‡∏°: <span id="prevWater">0</span></div>
                    </div>
                    
                    <div class="col-6">
                        <label class="form-label text-warning fw-bold">‚ö° ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü</label>
                        <input type="number" id="inputElectric" class="form-control form-control-lg text-center" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                        <div class="form-text text-end">‡πÄ‡∏î‡∏¥‡∏°: <span id="prevElectric">0</span></div>
                    </div>
                </div>

                <div id="calcPreview" class="mt-3 p-2 bg-light rounded d-none">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-success w-50" onclick="submitReading()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            </div>
        </div>
    </div>
</div>
	<div class="modal fade" id="moveInModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="moveInRoomId">
                <h4 class="text-center text-success mb-3" id="moveInRoomNum">‡∏´‡πâ‡∏≠‡∏á Axxx</h4>

                <form id="formMoveIn">
                    <div class="mb-2">
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ <span class="text-danger">*</span></label>
                        <input type="text" id="newTenantName" class="form-control" required>
                    </div>
					<div class="mb-2">
						<label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏ß‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•) <span class="text-danger">*</span></label>
						<input type="date" id="newStartDate" class="form-control" required>
					</div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" id="newTenantPhone" class="form-control" required>
                        </div>
                        <div class="col-6">
                            <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" id="newTenantCard" class="form-control">
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="newRentPrice" class="form-control" value="3500">
                        </div>
                        <div class="col-6">
                            <label>‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="newDeposit" class="form-control" value="5000">
                        </div>
                    </div>
                    <div class="alert alert-warning p-2 mt-3">
                        <strong>‚ö° ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)</strong>
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <label>‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                                <input type="number" id="initWater" class="form-control text-center" placeholder="0">
                            </div>
                            <div class="col-6">
                                <label>‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                                <input type="number" id="initElectric" class="form-control text-center" placeholder="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-success" onclick="submitMoveIn()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="billHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏• - ‡∏´‡πâ‡∏≠‡∏á <span id="billRoomNum"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th>
                                <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="billListBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editTenantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-user-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editContractId">
                <input type="hidden" id="editMeterId"> <div class="mb-3">
                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="editName" class="form-control">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="text" id="editPhone" class="form-control">
                    </div>
                    <div class="col-6">
                        <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                        <input type="text" id="editCard" class="form-control">
                    </div>
                </div>

                <hr>
                <h6 class="text-primary"><i class="fas fa-file-contract"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h6>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="editRent" class="form-control">
                    </div>
                    <div class="col-6">
                        <label>‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="editDeposit" class="form-control">
                    </div>
                </div>

                <div class="mb-3">
                    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <input type="date" id="editStartDate" class="form-control">
                </div>

                <div class="alert alert-warning p-2">
                    <small>‚ö° <b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏£‡∏∞‡∏ß‡∏±‡∏á!)</b>: ‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏á‡∏ú‡∏¥‡∏î‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å</small>
                    <div class="row g-2 mt-1">
                        <div class="col-6">
                            <label>‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
                            <input type="number" id="editInitWater" class="form-control text-center">
                        </div>
                        <div class="col-6">
                            <label>‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
                            <input type="number" id="editInitElec" class="form-control text-center">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" onclick="saveTenantChanges()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
        </div>
    </div>
</div>
    <script>
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        document.addEventListener('DOMContentLoaded', loadDashboard);

		async function loadDashboard() {
            try {
                const response = await fetch('api/dashboard.php');
                
                // ‡∏ñ‡πâ‡∏≤ Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡∏≠‡∏≠‡∏Å
                if (response.status === 401) {
                    window.location.href = 'test_login.html';
                    return;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Server ‡∏™‡πà‡∏á JSON ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error('Server Error:', text);
                    alert('‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (‡∏î‡∏π‡πÉ‡∏ô Console)');
                    return;
                }
                
                if (result.status === 'success') {
                    renderBuildings(result.data);
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ');
            } finally {
                // ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏°‡∏∏‡∏ô (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }
			// üî• [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            checkDueRooms();
        }
		
		async function checkDueRooms() {
            try {
                const res = await fetch('api/get_due_rooms.php');
                const result = await res.json();
                
                const alertArea = document.getElementById('alertArea');
                const listSpan = document.getElementById('dueRoomList');
                
                if (result.status === 'success' && result.data.length > 0) {
                    // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô comma
                    const roomNums = result.data.map(r => `<span class="badge bg-danger ms-1">${r.room_number}</span>`).join(' ');
                    listSpan.innerHTML = roomNums;
                    alertArea.classList.remove('d-none');
                } else {
                    alertArea.classList.add('d-none');
                }
            } catch (err) { console.error(err); }
        }
		
        function renderBuildings(data) {
            const container = document.getElementById('mainContainer');
            container.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
			
			// üî• [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏±‡∏ö]
            let countTotal = 0;
            let countOccupied = 0;

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ã‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏∂‡∏Å
            for (const [buildingName, rooms] of Object.entries(data)) {
                
                // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏∂‡∏Å
                const buildingHeader = document.createElement('h4');
                buildingHeader.className = 'mb-3 mt-2 text-primary border-bottom pb-2';
                buildingHeader.innerHTML = `<i class="fas fa-hotel"></i> ${buildingName}`;
                container.appendChild(buildingHeader);

                // Grid ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å
                const row = document.createElement('div');
                row.className = 'row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3 mb-4';

				rooms.forEach(room => {
					// üî• [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö]
                    countTotal++;
						if (room.status === 'occupied') {
							countOccupied++;
						}
                    const col = document.createElement('div');
                    col.className = 'col';
                    
                    let statusClass = 'status-available';
                    let icon = '<i class="fas fa-check-circle text-success"></i>';
                    let infoText = '<span class="text-success">‡∏ß‡πà‡∏≤‡∏á</span>';
                    let badgeHtml = ''; // üî• ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

					if (room.status === 'occupied') {
                        statusClass = 'status-occupied';
                        icon = '<i class="fas fa-user text-danger"></i>';
                        infoText = room.tenant_name ? room.tenant_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';

                        // -----------------------------------------------------------
                        // üî• Logic ‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (Today, Tomorrow, In X days)
                        // -----------------------------------------------------------
                        if (room.bill_status === 'paid') {
                            // 1. ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                            badgeHtml = '<span class="badge bg-success status-badge"><i class="fas fa-check-circle"></i> ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>';
                        } 
                        else if (room.bill_status === 'pending') {
                            // 2. ‡∏à‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢
                            badgeHtml = '<span class="badge bg-warning text-dark status-badge"><i class="fas fa-file-invoice-dollar"></i> ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</span>';
                        }
						else if (room.start_date) {
                            // 3. ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏î -> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô
                            const today = new Date();
                            const billDate = new Date(room.start_date);
                            
                            // üî• [‡πÄ‡∏û‡∏¥‡πà‡∏° Logic] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                            // ‡∏ñ‡πâ‡∏≤ ‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô => ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏î)
                            const isFirstMonth = (today.getFullYear() === billDate.getFullYear()) && 
                                                 (today.getMonth() === billDate.getMonth());

                            if (!isFirstMonth) {
                                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å ‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                                const billDay = billDate.getDate(); // ‡∏ß‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö
                                const currentDay = today.getDate(); // ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                                
                                let diff = billDay - currentDay;

                                if (diff === 0) {
                                    badgeHtml = '<span class="badge bg-danger status-badge blink">üîî ‡∏à‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!</span>';
                                } 
                                else if (diff === 1) {
                                    badgeHtml = '<span class="badge bg-warning text-dark status-badge">‚è≥ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ</span>';
                                }
                                else if (diff > 1 && diff <= 3) {
                                    badgeHtml = `<span class="badge bg-info text-dark status-badge">üìÖ ‡∏≠‡∏µ‡∏Å ${diff} ‡∏ß‡∏±‡∏ô</span>`;
                                }
                                else if (diff < 0 && diff >= -5) {
                                    badgeHtml = `<span class="badge bg-dark status-badge">‚ö†Ô∏è ‡πÄ‡∏•‡∏¢‡∏°‡∏≤ ${Math.abs(diff)} ‡∏ß‡∏±‡∏ô</span>`;
                                }
                            } else {
                                // (‡πÅ‡∏ñ‡∏°) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡πâ‡∏≤‡∏¢‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà" ‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
                                badgeHtml = '<span class="badge bg-info text-dark status-badge" style="background-color: #e2e3e5 !important;">üÜï ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà</span>';
                            }
                        }
                        /*else if (room.start_date) {
                            // 3. ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏î -> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                            const today = new Date();
                            const billDate = new Date(room.start_date);
                            const billDay = billDate.getDate(); // ‡∏ß‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏£‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5)
                            const currentDay = today.getDate(); // ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3)
                            
                            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (Target - Today)
                            // ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5, ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3 -> diff = 2 (‡∏≠‡∏µ‡∏Å 2 ‡∏ß‡∏±‡∏ô)
                            let diff = billDay - currentDay;

                            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1, ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 30) -> ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ä‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                            // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                            
                            if (diff === 0) {
                                // ‡∏ï‡∏£‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞
                                badgeHtml = '<span class="badge bg-danger status-badge blink">üîî ‡∏à‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!</span>';
                            } 
                            else if (diff === 1) {
                                // ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
                                badgeHtml = '<span class="badge bg-warning text-dark status-badge">‚è≥ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ</span>';
                            }
                            else if (diff > 1 && diff <= 3) {
                                // ‡∏≠‡∏µ‡∏Å 2-3 ‡∏ß‡∏±‡∏ô
                                badgeHtml = `<span class="badge bg-info text-dark status-badge">üìÖ ‡∏≠‡∏µ‡∏Å ${diff} ‡∏ß‡∏±‡∏ô</span>`;
                            }
                            else if (diff < 0 && diff >= -5) {
                                // ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏¢‡∏°‡∏≤ 2 ‡∏ß‡∏±‡∏ô) ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏î
                                // Math.abs ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å (-2 -> 2)
                                badgeHtml = `<span class="badge bg-dark status-badge">‚ö†Ô∏è ‡πÄ‡∏•‡∏¢‡∏°‡∏≤ ${Math.abs(diff)} ‡∏ß‡∏±‡∏ô</span>`;
                            }
                        }*/
                        // ----------------------------------------
                    } else if (room.status === 'maintenance') {
                        statusClass = 'status-maintenance';
                        icon = '<i class="fas fa-tools text-secondary"></i>';
                        infoText = '<span class="text-secondary">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</span>';
                    }
					
					// üî• [‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠]
					document.getElementById('statTotal').innerText = countTotal;
					document.getElementById('statOccupied').innerText = countOccupied;

				// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà)
					let billCycleText = '';
					if (room.status === 'occupied' && room.start_date) {
						const day = new Date(room.start_date).getDate(); // ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 5)
						billCycleText = `<div style="font-size: 0.7rem; color: #888; margin-top: 2px;"><i class="far fa-calendar-alt"></i> ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day}</div>`;
					}

					// ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Å‡∏≤‡∏£‡πå‡∏î
					col.innerHTML = `
						<div class="card h-100 room-card ${statusClass} position-relative" onclick="openRoomDetail(${room.id}, '${room.room_number}')">
							${badgeHtml} 
							<div class="card-body text-center p-2 pt-3">
								<div class="room-number">${room.room_number}</div>
								<div class="mb-1">${icon}</div>
								<div class="tenant-name">${infoText}</div>
								
								${billCycleText}
								
							</div>
						</div>
					`;
                    row.appendChild(col);
                });

                container.appendChild(row);
            }
        }

        async function logout() {
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                await fetch('api/logout.php');
                window.location.href = 'test_login.html';
            }
        }

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal
let meterModal;
let moveInModal;
let billModal;
let editTenantModal;

// üî• [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà
let currentOpenRoomId = null;
let currentOpenRoomNum = '';

document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
    meterModal = new bootstrap.Modal(document.getElementById('meterModal'));
    moveInModal = new bootstrap.Modal(document.getElementById('moveInModal'));
	billModal = new bootstrap.Modal(document.getElementById('billHistoryModal'));
	editTenantModal = new bootstrap.Modal(document.getElementById('editTenantModal'));
});

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏õ‡∏´‡∏¢‡∏≠‡∏î‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á)
function openEditTenant(contractId, name, phone, card, startDate) {
    document.getElementById('editContractId').value = contractId;
    document.getElementById('editName').value = name;
    document.getElementById('editPhone').value = phone || '';
    document.getElementById('editCard').value = card || '';
    document.getElementById('editStartDate').value = startDate;
    
    // ‡∏ã‡πà‡∏≠‡∏ô Modal ‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    meterModal.hide();
    editTenantModal.show();
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function saveTenantChanges() {
    // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏î‡∏π‡∏ß‡πà‡∏≤ iPad ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏´‡∏°
    const cid = document.getElementById('editContractId').value;
    const name = document.getElementById('editName').value;
    const phone = document.getElementById('editPhone').value;
    const card = document.getElementById('editCard').value;
    const start = document.getElementById('editStartDate').value;

    // üî• [Debug 1] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏°
    if(!name) { alert('‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤'); return; }
    if(!start) { alert('‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà)'); return; }

    // üî• [Debug 2] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
    // alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... ' + name); 

    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?')) {
        try {
            const res = await fetch('api/update_tenant.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }, // ‡πÄ‡∏û‡∏¥‡πà‡∏° Header ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå
                body: JSON.stringify({
                    contract_id: cid, 
                    fullname: name, 
                    phone: phone, 
                    id_card: card, 
                    start_date: start
                })
            });
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠ Error HTML
            const text = await res.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch(e) {
                alert('‚ùå Server Error:\n' + text); // ‡∏ü‡πâ‡∏≠‡∏á Error ‡∏ñ‡πâ‡∏≤ PHP ‡∏û‡∏±‡∏á
                return;
            }
            
            if(result.status === 'success') {
                alert('‚úÖ ' + result.message);
                
                // ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏Å‡∏±‡∏ô Error ‡∏ö‡∏ô iPad)
                const modalEl = document.getElementById('editTenantModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                    modalInstance.hide();
                } else {
                    // Fallback ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ instance ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
                    new bootstrap.Modal(modalEl).hide();
                }

                loadDashboard(); 
            } else {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
            }
        } catch(err) { 
            alert('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Connection Error): ' + err); 
        }
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏¥‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ)
async function openRoomDetail(roomId, roomNum) {
    // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    document.getElementById('prevWater').innerText = '...';
    document.getElementById('prevElectric').innerText = '...';
    document.getElementById('inputWater').value = '';
    document.getElementById('inputElectric').value = '';
    document.getElementById('modalContractId').value = '';
    
	// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà default
    const today = new Date().toISOString().split('T')[0];
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
    document.getElementById('recordDate').value = today;
    document.getElementById('dueDate').value = today; // üî• ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏ö‡πÄ‡∏•‡∏¢

    try {
        const res = await fetch(`api/get_room_detail.php?id=${roomId}&v=${Date.now()}`);
        const result = await res.json();

        // üî• [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic] ‡πÉ‡∏ä‡πâ if...else ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
        if (result.status === 'success') {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ B: ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà (Success) ---
            const data = result.data;
            const editBtn = `
                <button class="btn btn-sm btn-outline-warning ms-2" 
                    onclick="loadAndOpenEdit(${data.id})">
                    <i class="fas fa-edit"></i>
                </button>
            `;

            document.getElementById('modalRoomNum').innerText = data.room_number;
            document.getElementById('modalTenantName').innerHTML = `
                ${data.fullname} ${editBtn}
                <div class="mt-2">
                    <button class="btn btn-sm btn-info text-white me-1" onclick="openBillHistory(${data.room_id}, '${data.room_number}')">
                        <i class="fas fa-receipt"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•/‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="moveOut(${data.room_id})">
                        ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
                    </button>
                </div>
            `;
            
            document.getElementById('modalContractId').value = data.id;
            document.getElementById('prevWater').innerText = data.last_water;
            document.getElementById('prevElectric').innerText = data.last_electric;
            
            meterModal.show();

        } else {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ A: ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡∏´‡∏£‡∏∑‡∏≠ Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô) ---
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° message ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢
            
            document.getElementById('moveInRoomId').value = roomId;
            document.getElementById('moveInRoomNum').innerText = '‡∏´‡πâ‡∏≠‡∏á ' + roomNum;
            document.getElementById('newStartDate').valueAsDate = new Date();
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            document.getElementById('initWater').value = '';
            document.getElementById('initElectric').value = '';
            
            moveInModal.show();
        }

    } catch (err) {
        // Fallback ‡∏Å‡∏£‡∏ì‡∏µ Error ‡∏´‡∏ô‡∏±‡∏Å‡πÜ (Server ‡∏û‡∏±‡∏á)
        console.error(err);
        document.getElementById('moveInRoomId').value = roomId;
        document.getElementById('moveInRoomNum').innerText = '‡∏´‡πâ‡∏≠‡∏á ' + roomNum; // ‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢
        moveInModal.show();
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å (Move In)
async function submitMoveIn() {
    const roomId = document.getElementById('moveInRoomId').value;
    const name = document.getElementById('newTenantName').value;
    const phone = document.getElementById('newTenantPhone').value;
    const rent = document.getElementById('newRentPrice').value;
    const deposit = document.getElementById('newDeposit').value;
    const initW = document.getElementById('initWater').value;
    const initE = document.getElementById('initElectric').value;
	// üî• [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    const startDate = document.getElementById('newStartDate').value;

	if(!name || !initW || !initE || !startDate) { // ‡πÄ‡∏ä‡πá‡∏Ñ startDate ‡∏î‡πâ‡∏ß‡∏¢
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
    }

    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?')) {
        const res = await fetch('api/manage_contract.php', {
            method: 'POST',
            body: JSON.stringify({
                action: 'move_in',
                room_id: roomId,
                fullname: name,
                phone: phone,
                rent_price: rent,
                deposit: deposit,
                init_water: initW,
                init_electric: initE,
                start_date: startDate // üî• ‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ PHP ‡πÉ‡∏ä‡πâ CURDATE)
            })
        });
        const result = await res.json();
        if(result.status === 'success') {
            alert(result.message);
            moveInModal.hide();
            loadDashboard(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        } else {
            alert(result.message);
        }
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (Move Out)
async function moveOut(roomId) {
    if(confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n- ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ\n- ‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏á')) {
        const res = await fetch('api/manage_contract.php', {
            method: 'POST',
            body: JSON.stringify({
                action: 'move_out',
                room_id: roomId
            })
        });
        const result = await res.json();
        if(result.status === 'success') {
            alert(result.message);
            meterModal.hide();
            loadDashboard();
        } else {
            alert(result.message);
        }
    }
}

	// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
	async function submitReading() {
		const contractId = document.getElementById('modalContractId').value;
		const currentWater = document.getElementById('inputWater').value;
		const currentElectric = document.getElementById('inputElectric').value;
		// ... (‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå) ...
		const recDate = document.getElementById('recordDate').value;
		const dueDate = document.getElementById('dueDate').value;

		if(!currentWater || !currentElectric) {
			alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏≠‡∏á');
			return;
		}

		if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?')) {
			try {
				const res = await fetch('api/save_reading.php', {
					method: 'POST',
					// ...
					body: JSON.stringify({
						// ... (‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°) ...
						contract_id: contractId,
						current_water: currentWater,
						current_electric: currentElectric,
						
						// üî• [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡πÉ‡∏´‡πâ API
						reading_date: recDate,
						due_date: dueDate
					})
				});
				
				const result = await res.json();
				
			if(result.status === 'success') {
                // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ] ‡∏ã‡πà‡∏≠‡∏ô Modal ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
                meterModal.hide();
                loadDashboard(); 

                // ‡∏ñ‡∏≤‡∏° user ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°
                if(confirm(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${result.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà (Popup)
                    const printUrl = `print_bill.php?id=${result.invoice_id}`;
                    window.open(printUrl, 'printWindow', 'width=400,height=600');
                }
            } else {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
            }

			} catch (err) {
				console.error(err);
				alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
			}
		}
	}
	
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•
async function openBillHistory(roomId, roomNum) {
	// üî• [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
    currentOpenRoomId = roomId;
    currentOpenRoomNum = roomNum;
	
    document.getElementById('billRoomNum').innerText = roomNum;
    const tbody = document.getElementById('billListBody');
    tbody.innerHTML = '<tr><td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

    meterModal.hide(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô
    billModal.show();  // ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏¥‡∏•

    try {
        const res = await fetch(`api/get_bills.php?room_id=${roomId}`);
        const result = await res.json();

        tbody.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

			result.data.forEach(bill => {
                let statusBadge, actionBtn;
    
			// ----------------------------------------------------
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° LINE (Logic ‡πÉ‡∏´‡∏°‡πà)
            // ----------------------------------------------------
            let btnLineHTML = '';
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏°‡∏µ Line ID ‡πÑ‡∏´‡∏°?
            if (bill.line_user_id) {
                // A. ‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡πà‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                if (bill.line_sent_at) {
                    // ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß -> ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
                    btnLineHTML = `
                        <button class="btn btn-outline-primary" onclick="sendLineConfirm(${bill.id})" style="min-width: 100px;">
                            <i class="fab fa-line"></i> ‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
                        </button>
                        <div class="text-success mt-1" style="font-size: 0.7rem;"><i class="fas fa-check-double"></i> ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
                    `;
                } else {
                    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á -> ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
                    btnLineHTML = `
                        <button class="btn btn-primary" onclick="sendLineConfirm(${bill.id})" style="min-width: 100px;">
                            <i class="fab fa-line"></i> ‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•
                        </button>
                    `;
                }
            } else {
                // B. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ "‡πÑ‡∏°‡πà‡∏û‡∏ö Line"
                btnLineHTML = `
                    <button class="btn btn-light text-muted border" disabled style="min-width: 100px; cursor: not-allowed;">
                        <i class="fab fa-line"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ Line
                    </button>
                `;
            }

            // ----------------------------------------------------
            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
            // ----------------------------------------------------
            if (bill.is_paid) {
                // --- ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ---
                statusBadge = `<span class="badge bg-success rounded-pill">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
                actionBtn = `
                    <button class="btn btn-secondary" onclick="printBill(${bill.id})">
                        <i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                    </button>
                `;
            } else {
                // --- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢ ---
                statusBadge = `<span class="badge bg-danger rounded-pill">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</span>`;
                
                actionBtn = `
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div class="d-flex flex-column align-items-center">
                            ${btnLineHTML}
                        </div>
                        
                        <button class="btn btn-success" onclick="payBill(${bill.id}, ${bill.total_amount})" style="min-width: 100px;">
                            <i class="fas fa-hand-holding-usd"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
                        </button>

                        <div class="d-flex gap-1">
                            <button class="btn btn-light border" title="‡∏û‡∏¥‡∏°‡∏û‡πå" onclick="printBill(${bill.id})">
                                <i class="fas fa-print text-secondary"></i>
                            </button>
                            <button class="btn btn-light border border-danger text-danger" title="‡∏•‡∏ö‡∏ö‡∏¥‡∏•" onclick="deleteBill(${bill.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            const row = `
                <tr>
                    <td>${bill.formatted_date}<br><small class="text-muted">${bill.invoice_number}</small></td>
                    <td class="fw-bold text-primary">${parseFloat(bill.total_amount).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

    } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="4" class="text-danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>';
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
async function payBill(invId, amount) {
    if(confirm(`üí∞ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô...`)) {
        try {
            const res = await fetch('api/pay_bill.php', {
                method: 'POST',
                body: JSON.stringify({ invoice_id: invId, payment_method: 'cash' })
            });
            const result = await res.json();
            
            if(result.status === 'success') {
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');

                // ‚ùå ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°: billModal.hide(); (‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á)
                
                // üî• [‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô] ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                openBillHistory(currentOpenRoomId, currentOpenRoomNum);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢
                loadDashboard();
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
            }
        } catch (err) {
            alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
        }
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÜ)
function printBill(invId) {
    const printUrl = `print_bill.php?id=${invId}`;
    window.open(printUrl, 'printWindow', 'width=400,height=600');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á LINE (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
async function sendLineConfirm(invId) {
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert ‡πÄ‡∏õ‡πá‡∏ô confirm (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥) ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ confirm ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
    // (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Å‡∏î Confirm ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏≥)
    
    // ... (‡∏™‡πà‡∏ß‡∏ô fetch) ...
    try {
        const res = await fetch('api/send_bill.php', {
            method: 'POST',
            body: JSON.stringify({ invoice_id: invId })
        });
        const result = await res.json();
        
        alert(result.message); // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß

        // üî• [‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ] ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Auto Refresh)
        if (currentOpenRoomId) {
            openBillHistory(currentOpenRoomId, currentOpenRoomNum);
        }

    } catch (err) {
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏ö‡∏¥‡∏• (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏î‡πÉ‡∏´‡∏°‡πà)
async function deleteBill(invId) {
    if(confirm('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?...')) {
        try {
            const res = await fetch('api/delete_bill.php', {
                method: 'POST',
                body: JSON.stringify({ invoice_id: invId })
            });
            const result = await res.json();
            
            if(result.status === 'success') {
                // alert(result.message); // (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏´‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏•‡∏¢)
                
                // üî• [‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ] ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏•‡∏ö‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á)
                openBillHistory(currentOpenRoomId, currentOpenRoomNum);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
                loadDashboard(); 
            } else {
                alert(result.message);
            }
        } catch (err) {
            alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
        }
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÉ‡∏™‡πà Modal (‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)
async function loadAndOpenEdit(contractId) {
    try {
        meterModal.hide(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const res = await fetch(`api/get_contract_info.php?contract_id=${contractId}`);
        const result = await res.json();

        if (result.status === 'success') {
            const d = result.data;
            
            // ‡∏´‡∏¢‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á
            document.getElementById('editContractId').value = d.id;
            document.getElementById('editMeterId').value = d.meter_id; // ID ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
            
            document.getElementById('editName').value = d.fullname;
            document.getElementById('editPhone').value = d.phone;
            document.getElementById('editCard').value = d.id_card;
            
            document.getElementById('editRent').value = parseFloat(d.rent_price);
            document.getElementById('editDeposit').value = parseFloat(d.deposit);
            document.getElementById('editStartDate').value = d.start_date;
            
            document.getElementById('editInitWater').value = d.initial_water;
            document.getElementById('editInitElec').value = d.initial_electric;

            editTenantModal.show();
        } else {
            alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
    } catch(err) {
        console.error(err);
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà)
async function saveTenantChanges() {
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?')) return;

    try {
        const payload = {
            contract_id: document.getElementById('editContractId').value,
            meter_id: document.getElementById('editMeterId').value,
            fullname: document.getElementById('editName').value,
            phone: document.getElementById('editPhone').value,
            id_card: document.getElementById('editCard').value,
            
            rent_price: document.getElementById('editRent').value,
            deposit: document.getElementById('editDeposit').value,
            start_date: document.getElementById('editStartDate').value,
            
            initial_water: document.getElementById('editInitWater').value,
            initial_electric: document.getElementById('editInitElec').value
        };

        const res = await fetch('api/update_tenant.php', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        const result = await res.json();

        if(result.status === 'success') {
            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            editTenantModal.hide();
            loadDashboard();
        } else {
            alert('‚ùå Error: ' + result.message);
        }
    } catch(err) {
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    }
}
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>