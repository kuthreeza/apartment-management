<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8f9fa; }
        .card-icon { font-size: 2rem; opacity: 0.8; }
        
        /* üî• ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) */
        @media print {
            /* 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (Landscape) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡∏π‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤ */
            @page { 
                size: A4 landscape; 
                margin: 10mm; 
            }

            /* 2. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≤‡∏ß‡∏ã‡∏µ‡∏î) */
            body { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                background-color: white !important;
            }

            /* 3. ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞ Navbar ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
            .no-print, .navbar, button { 
                display: none !important; 
            }

            /* 4. ‡∏à‡∏±‡∏î layout ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
            .container {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* 5. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏î */
            .card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ddd !important; /* ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ï‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô */
                box-shadow: none !important; /* ‡∏•‡∏ö‡πÄ‡∏á‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏≠‡∏∞ */
            }
            
            tr { page-break-inside: avoid; }

            /* 6. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏õ */
            #incomeChart {
                max-height: 300px !important;
                width: 100% !important;
            }
            
            /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
            .bg-success, .bg-warning, .bg-primary, .bg-info {
                color: white !important; 
            }
            .text-white {
                color: white !important;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary no-print mb-4">
        <div class="container">
            <span class="navbar-brand">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å</span>
            <a href="dashboard.html" class="btn btn-outline-light btn-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="card mb-4 no-print shadow-sm">
            <div class="card-body py-2">
                <div class="row align-items-end g-2">
                    <div class="col-md-3">
                        <label class="small text-muted">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <button onclick="loadReport()" class="btn btn-primary w-100"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                    <div class="col-md-3">
                        <button onclick="window.print()" class="btn btn-secondary w-100">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mb-4">
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <p class="text-muted" id="reportRange">...</p>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card bg-success text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß)</h6>
                                <h2 class="mb-0 fw-bold" id="txtIncome">0</h2>
                                <small id="txtPaidBills">0 ‡∏ö‡∏¥‡∏•</small>
                            </div>
                            <div class="card-icon">üí∞</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-dark h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢)</h6>
                                <h2 class="mb-0 fw-bold" id="txtPending">0</h2>
                            </div>
                            <div class="card-icon">‚è≥</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body">
                        <h6>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ï‡∏∂‡∏Å (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö)</h6>
                        <ul id="buildingList" class="list-unstyled mb-0 small">
                            <li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-white fw-bold">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
            <div class="card-body">
                <canvas id="incomeChart" height="100"></canvas>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•</div>
            <div class="table-responsive">
                <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th>
                            <th>‡∏´‡πâ‡∏≠‡∏á</th>
                            <th>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</th>
                            <th class="text-end">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
        const date = new Date();
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô format YYYY-MM-DD ‡πÉ‡∏´‡πâ input date
        document.getElementById('startDate').valueAsDate = firstDay;
        document.getElementById('endDate').valueAsDate = date;

        let myChart = null;

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        loadReport();

        async function loadReport() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            document.getElementById('reportRange').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(start)} ‡∏ñ‡∏∂‡∏á ${formatDate(end)}`;

            try {
                const res = await fetch(`api/get_report.php?start=${start}&end=${end}`);
                const result = await res.json();

                if (result.status === 'success') {
                    renderSummary(result.summary);
                    renderBuildingStats(result.by_building);
                    renderChart(result.daily);
                    renderTable(result.list);
                }
            } catch (err) {
                console.error(err);
                alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function renderSummary(data) {
            document.getElementById('txtIncome').innerText = parseFloat(data.total_income || 0).toLocaleString();
            document.getElementById('txtPaidBills').innerText = `${data.paid_bills} ‡∏ö‡∏¥‡∏•`;
            document.getElementById('txtPending').innerText = parseFloat(data.total_pending || 0).toLocaleString();
        }

        function renderBuildingStats(data) {
            const list = document.getElementById('buildingList');
            list.innerHTML = '';
            if(data.length === 0) { list.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>'; return; }
            
            data.forEach(b => {
                list.innerHTML += `<li class="d-flex justify-content-between">
                    <span>${b.name}</span>
                    <span>${parseFloat(b.amount).toLocaleString()}</span>
                </li>`;
            });
        }

        function renderChart(dailyData) {
            const ctx = document.getElementById('incomeChart').getContext('2d');
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü
            const labels = dailyData.map(d => formatDate(d.pay_date));
            const values = dailyData.map(d => d.total);

            if (myChart) myChart.destroy(); // ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ö‡∏≤‡∏ó)',
                        data: values,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderTable(list) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            list.forEach(item => {
                let statusBadge = item.status === 'paid' 
                    ? '<span class="badge bg-success">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>' 
                    : '<span class="badge bg-danger">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>';
                
                let paidDate = item.paid_at ? `<br><small class="text-muted">‡∏à‡πà‡∏≤‡∏¢: ${formatDate(item.paid_at)}</small>` : '';

                const row = `<tr>
                    <td>${formatDate(item.created_at)}</td>
                    <td>${item.invoice_number}</td>
                    <td><span class="badge bg-primary">${item.room_number}</span></td>
                    <td>${item.fullname}</td>
                    <td class="text-end fw-bold">${parseFloat(item.total_amount).toLocaleString()}</td>
                    <td class="text-center">${statusBadge}${paidDate}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function formatDate(dateString) {
            if(!dateString) return '-';
            const d = new Date(dateString);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }
    </script>
</body>
</html>